import{g as _}from"./supabaseClient-BZSWgoCJ.js";import{getUser as E}from"./core-DFjEd1v7.js";const w="seoulsurvival";var N,R;const d=!!((R=(N=import.meta)==null?void 0:N.env)!=null&&R.DEV);function L(e){if(!e||typeof e!="string")return{raw:"",key:""};const r=e.trim().normalize("NFC"),o=r.toLowerCase();return{raw:r,key:o}}function A(e){const{raw:t,key:r}=L(e);return!t||t.length===0?{ok:!1,reasonKey:"empty"}:t.length<1?{ok:!1,reasonKey:"tooShort"}:t.length>6?{ok:!1,reasonKey:"tooLong"}:/^[가-힣a-zA-Z0-9_]+$/.test(t)?M(t,r)?{ok:!1,reasonKey:"banned"}:{ok:!0}:{ok:!1,reasonKey:"invalid"}}function M(e,t){const r=["시발","좆","개새끼","병신","미친","지랄","닥쳐","엿","좆까","fuck","shit","bitch","asshole","damn","crap","piss","멍청이","바보","등신","호구","admin","administrator","root","system","null","undefined"],o=e.toLowerCase(),n=t.toLowerCase();for(const s of r)if(n.includes(s.toLowerCase())||o.includes(s.toLowerCase()))return!0;return!1}async function v(e,t){var s;const r=await _();if(!r)return{success:!1,error:"network",message:"Supabase not configured"};const{raw:o,key:n}=L(e);if(!n)return{success:!1,error:"unknown",message:"Invalid nickname"};try{const{data:a,error:c}=await r.rpc("claim_nickname",{p_game_slug:w,p_nickname_key:n,p_nickname_raw:o,p_user_id:t});return c?c.code==="PGRST116"||(s=c.message)!=null&&s.includes("does not exist")?(d&&console.warn("[LB] nickname_registry table not found, run supabase/nickname_registry.sql"),{success:!1,error:"network",message:"Nickname registry not configured"}):(console.error("Claim nickname error:",c),{success:!1,error:"network",message:c.message}):a&&typeof a=="object"?a.success?{success:!0,message:a.message||"Nickname claimed"}:{success:!1,error:a.error||"unknown",message:a.message||"Failed to claim nickname"}:{success:!1,error:"unknown",message:"Unexpected response format"}}catch(a){return console.error("Claim nickname exception:",a),{success:!1,error:"network",message:a.message||"Network error"}}}async function F(e,t=w){var o;const r=await _();if(!r)return{success:!1,error:"network",message:"Supabase not configured"};if(!e)return{success:!1,error:"unknown",message:"User ID required"};try{const{data:n,error:s}=await r.rpc("release_nickname",{p_game_slug:t,p_user_id:e});return s?s.code==="PGRST116"||(o=s.message)!=null&&o.includes("does not exist")?(d&&console.warn("[LB] release_nickname RPC not found, nickname_registry may not be set up"),{success:!1,error:"network",message:"Nickname registry not configured"}):(console.error("Release nickname error:",s),{success:!1,error:"network",message:s.message}):n&&typeof n=="object"?n.success?(d&&console.log("[LB] Nickname released:",n.released_key||"none"),{success:!0,message:n.message||"Nickname released"}):{success:!1,error:n.error||"unknown",message:n.message||"Failed to release nickname"}:{success:!1,error:"unknown",message:"Unexpected response format"}}catch(n){return console.error("Release nickname exception:",n),{success:!1,error:"network",message:n.message||"Network error"}}}function h(e,t="unknown"){if(e==null)return d&&console.warn(`[LB] ${t} is null/undefined, using 0`),0;const r=typeof e=="string"?parseFloat(e):Number(e);if(!Number.isFinite(r))return d&&console.warn(`[LB] ${t} is not finite (${e}), using 0`),0;const o=Math.floor(r),n=Math.max(0,o);if(d){const s=r!==o&&Number.isFinite(r),a=r<0;if(s||a){const c=[];s&&c.push("was decimal"),a&&c.push("was negative"),console.debug(`[LB] ${t} converted from ${r} to ${n} (${c.join(", ")})`)}}return n}let S=0,B="",k=0;const x=5e3;let m=null,b=0,T=!1;const P=15e3,D=0;function C(e,t=""){const r=Date.now(),o=(e==null?void 0:e.message)||String(e);if(o===B&&r-S<x){k++;return}k>0?(console.error(`[LB] Leaderboard error (repeated ${k} times):`,e,t),k=0):console.error("[LB] Leaderboard error:",e,t),S=r,B=o}async function K(e,t,r,o=0,n=!1){try{const s=await E();if(!s)return d&&console.log("Leaderboard: User not logged in, skipping update"),{success:!1,error:"Not logged in"};const a=h(t,"total_assets"),c=h(r,"play_time_ms"),i=h(o,"tower_count"),l={nickname:L(e||"익명"),total_assets:a,play_time_ms:c,tower_count:i};if(m&&m.nickname===l.nickname&&m.total_assets===l.total_assets&&m.play_time_ms===l.play_time_ms&&m.tower_count===l.tower_count)return d&&console.debug("[LB] Skipping update: payload unchanged"),{success:!0,data:null,skipped:!0};const g=Date.now(),u=n?D:P;if(!n&&T&&g-b<u)return d&&console.debug(`[LB] Throttled: ${Math.round((u-(g-b))/1e3)}s remaining`),{success:!0,data:null,skipped:!0,throttled:!0};d&&console.debug("[LB] updateLeaderboard payload:",{nickname:e,totalAssets:{raw:t,safe:a,type:typeof t},playTimeMs:{raw:r,safe:c,type:typeof r},towerCount:{raw:o,safe:i,type:typeof o},forceImmediate:n});const f=await _();if(!f)return{success:!1,error:"Supabase client not available"};const{data:y,error:p}=await f.from("leaderboard").upsert({user_id:s.id,game_slug:w,nickname:e||"익명",total_assets:a,play_time_ms:c,tower_count:i,updated_at:new Date().toISOString()},{onConflict:"user_id,game_slug"}).select().single();return p?(C(p,{nickname:e,safeTotalAssets:a,safePlayTimeMs:c,safeTowerCount:i}),{success:!1,error:p.message}):(m=l,b=g,T=!0,d&&console.debug("[LB] Leaderboard updated successfully:",y),{success:!0,data:y})}catch(s){return C(s,"exception"),b=Date.now(),T=!1,{success:!1,error:s.message}}}async function z(e=10,t="assets"){var r,o,n,s,a,c;try{const i=await _();if(!i)return console.error("Leaderboard: Supabase client not configured"),console.warn("[LB] fetch failed",{reason:"not_configured",phase:"init"}),{success:!1,error:"Supabase가 설정되지 않았습니다. shared/auth/config.js를 확인해주세요.",data:[],errorType:"config"};let l=i.from("leaderboard").select("nickname, total_assets, play_time_ms, tower_count, updated_at").eq("game_slug",w).limit(e);t==="assets"?l=l.order("tower_count",{ascending:!1}).order("total_assets",{ascending:!1}):t==="playtime"&&(l=l.order("play_time_ms",{ascending:!1}));const{data:g,error:u}=await l;if(u){console.error("Leaderboard fetch error:",u);const f=u.status??u.code??null,y=u.code==="PGRST116"||((r=u.message)==null?void 0:r.includes("relation"))||((o=u.message)==null?void 0:o.includes("does not exist")),p=f===401||f===403||((s=(n=u.message)==null?void 0:n.toLowerCase)==null?void 0:s.call(n).includes("permission denied"))||((c=(a=u.message)==null?void 0:a.toLowerCase)==null?void 0:c.call(a).includes("rls"));return console.warn("[LB] fetch failed",{phase:"select",status:f,code:u.code,message:u.message,details:u.details,hint:u.hint}),y?{success:!1,error:"리더보드 테이블이 없습니다. Supabase SQL Editor에서 supabase/leaderboard.sql을 실행해주세요.",data:[],errorType:"schema",status:f}:p?{success:!1,error:"권한이 없어 리더보드를 불러올 수 없습니다.",data:[],errorType:"forbidden",status:f}:{success:!1,error:u.message,data:[],errorType:"generic",status:f}}return{success:!0,data:g||[]}}catch(i){return console.error("Leaderboard fetch exception:",i),console.warn("[LB] fetch failed",{phase:"exception",message:i==null?void 0:i.message,error:i}),{success:!1,error:i.message||"알 수 없는 오류",data:[],errorType:"network"}}}async function G(e,t="assets"){const r=await _();if(!r)return console.warn("[LB] my_rank failed",{reason:"not_configured"}),{success:!1,data:null,errorType:"config"};const n=L(e).toLowerCase();if(!n)return{success:!1,data:null,errorType:"no_nickname"};try{const{data:s,error:a,status:c}=await r.rpc("get_my_rank",{p_game_slug:w,p_nickname:n,p_sort_by:t});if(a){console.error("My rank RPC error:",a),console.warn("[LB] my_rank failed",{phase:"rpc",status:c??a.status,code:a.code,message:a.message,details:a.details,hint:a.hint});const l=c===401||c===403?"forbidden":"generic";return{success:!1,data:null,error:a.message,errorType:l,status:c??a.status}}const i=Array.isArray(s)?s[0]:s;return i?{success:!0,data:{rank:i.rank,nickname:i.nickname,total_assets:i.total_assets,play_time_ms:i.play_time_ms,tower_count:i.tower_count||0}}:{success:!1,data:null,errorType:"not_found"}}catch(s){return console.error("My rank RPC exception:",s),console.warn("[LB] my_rank failed",{phase:"exception",message:s==null?void 0:s.message,error:s}),{success:!1,data:null,error:s.message||"알 수 없는 오류",errorType:"network"}}}export{G as a,v as c,z as g,L as n,F as r,K as u,A as v};
