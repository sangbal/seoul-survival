import{createClient as Y}from"https://esm.sh/@supabase/supabase-js@2.49.1";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))r(a);new MutationObserver(a=>{for(const i of a)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&r(n)}).observe(document,{childList:!0,subtree:!0});function o(a){const i={};return a.integrity&&(i.integrity=a.integrity),a.referrerPolicy&&(i.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?i.credentials="include":a.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(a){if(a.ep)return;a.ep=!0;const i=o(a);fetch(a.href,i)}})();const V={BASE_URL:"./",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im52eGR3YWNxbWlvZnBlbm51a2VvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4OTMwNDYsImV4cCI6MjA4MTQ2OTA0Nn0.v2UoOk7xdmascY10Oy8fT3kYTWm9gWKSC9C4wH4nwP4",VITE_SUPABASE_URL:"https://nvxdwacqmiofpennukeo.supabase.co"},I=typeof import.meta<"u"&&V?V:{};try{console.log("[env] VITE_SUPABASE_URL:",I.VITE_SUPABASE_URL),console.log("[env] VITE_SUPABASE_ANON_KEY length:",(I.VITE_SUPABASE_ANON_KEY||"").length)}catch{}const _=I.VITE_SUPABASE_URL??"",S=I.VITE_SUPABASE_ANON_KEY??"",G="clicksurvivor-auth";function W(){const e=typeof _=="string"&&typeof S=="string"&&_.startsWith("https://")&&_.length>8&&S.length>0;if(!e)try{console.warn("[auth] Supabase not configured",{urlEmpty:!_,anonEmpty:!S,urlValue:_||"(empty)",anonLen:(S||"").length})}catch{}return e}function w(){return W()?Y(_,S,{auth:{storageKey:G,persistSession:!0,autoRefreshToken:!0,detectSessionInUrl:!0}}):null}let A=null;function p(){return A||(A=w(),A)}function k(){return W()}async function H(){const e=p();if(!e)return{ok:!1,reason:"not_configured"};if(!(typeof location<"u"&&/[?&]code=/.test(location.search)))return{ok:!0,exchanged:!1};try{const{error:o}=await e.auth.exchangeCodeForSession(location.href);if(o)return{ok:!1,reason:"exchange_failed",error:o};const r=new URL(location.href);return r.searchParams.delete("code"),r.searchParams.delete("state"),history.replaceState(null,"",r.toString()),{ok:!0,exchanged:!0}}catch(o){return{ok:!1,reason:"exchange_failed",error:o}}}async function U(){const e=p();if(!e)return null;const{data:t}=await e.auth.getUser();return(t==null?void 0:t.user)||null}async function j(e){const t=p();if(!t)return{ok:!1,reason:"not_configured"};const o=location.origin+location.pathname+location.search.replace(/([?&])code=[^&]+(&|$)/,"$1").replace(/[?&]state=[^&]+(&|$)/,"$1"),{error:r}=await t.auth.signInWithOAuth({provider:e,options:{redirectTo:o}});return r?{ok:!1,reason:"oauth_failed",error:r}:{ok:!0}}async function J(){const e=p();if(!e)return{ok:!1,reason:"not_configured"};const{error:t}=await e.auth.signOut();return t?{ok:!1,reason:"signout_failed",error:t}:{ok:!0}}function q(e){const t=p();if(!t)return()=>{};const{data:o}=t.auth.onAuthStateChange((r,a)=>{e((a==null?void 0:a.user)||null)});return()=>o.subscription.unsubscribe()}async function Z(){const e=w();if(!e)return{ok:!1,reason:"not_configured"};const t=await U();if(!t)return{ok:!1,reason:"not_signed_in"};try{const{error:o}=await e.from("game_saves").delete().eq("user_id",t.id);if(o)return console.error("Failed to delete game_saves:",o),{ok:!1,reason:"delete_saves_failed",error:o};const{error:r}=await e.from("leaderboard").delete().eq("user_id",t.id);return r?(console.error("Failed to delete leaderboard:",r),{ok:!1,reason:"delete_leaderboard_failed",error:r}):{ok:!0}}catch(o){return console.error("Exception while deleting user data:",o),{ok:!1,reason:"exception",error:o}}}async function z(){const e=w();if(!e)return{ok:!1,status:"NOT_CONFIGURED",reason:"not_configured"};if(!await U())return{ok:!1,status:"AUTH_FAILED",reason:"not_signed_in"};const{data:{session:o},error:r}=await e.auth.getSession();if(r||!(o!=null&&o.access_token))return{ok:!1,status:"AUTH_FAILED",reason:"no_session",error:r};const a=o.access_token,i=`${_}/functions/v1/delete-account`;try{const n=new AbortController,s=setTimeout(()=>n.abort(),3e4),f=await fetch(i,{method:"POST",headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/json"},signal:n.signal});if(clearTimeout(s),!f.ok){let h;try{h=await f.json()}catch{h={status:"UNKNOWN_ERROR",message:`HTTP ${f.status}`}}return{ok:!1,status:h.status||"UNKNOWN_ERROR",reason:h.message||`HTTP ${f.status}`,error:h,httpStatus:f.status}}const c=await f.json();return c.status==="ALL_SUCCESS"?{ok:!0,status:"ALL_SUCCESS"}:c.status==="DATA_DELETED_BUT_AUTH_DELETE_FAILED"?{ok:!1,status:"DATA_DELETED_BUT_AUTH_DELETE_FAILED",reason:"Data deleted but account deletion failed"}:{ok:!1,status:c.status||"UNKNOWN_ERROR",reason:c.message||"Unknown error"}}catch(n){return n.name==="AbortError"?{ok:!1,status:"UNKNOWN_ERROR",reason:"timeout",error:n}:(console.error("Delete account exception:",n),{ok:!1,status:"UNKNOWN_ERROR",reason:"network_error",error:n})}}function X(e){var t,o,r,a;return e?((t=e.user_metadata)==null?void 0:t.full_name)||((o=e.user_metadata)==null?void 0:o.name)||((r=e.user_metadata)==null?void 0:r.preferred_username)||e.email||((a=e.id)==null?void 0:a.slice(0,8)):null}function Q(e){return e&&e.email||null}async function ee(e){const{scope:t="hub",providerButtons:o=[],defaultProvider:r="google",loginBtn:a,logoutBtn:i,userLabel:n,statusLabel:s,toast:f}=e||{},c=typeof f=="function"?f:()=>{};await H();function h(u){const l=X(u);n&&(n.textContent=l||(t==="hub"?"Guest":"게스트"),n.hidden=!1),s&&(k()?l?(s.textContent=t==="hub"?"Signed in":"로그인됨",s.style.color="rgba(52, 211, 153, .95)"):(s.textContent=t==="hub"?"Not signed in":"로그인 안 됨",s.style.color="rgba(148, 163, 184, .95)"):(s.textContent=t==="hub"?"Guest mode (로그인 준비 중)":"게스트 모드 (로그인 준비 중)",s.style.color="rgba(148, 163, 184, .95)")),a&&(a.hidden=!!l),i&&(i.hidden=!l);const b=document.getElementById("authProviderButtons");b&&(b.style.display=l?"none":"flex");const v=document.getElementById("accountGuestInfo");v&&(v.style.display=l?"none":"block");const D=document.getElementById("accountLoggedInInfo");D&&(D.style.display=l?"block":"none");const O=document.getElementById("accountOverviewSection");O&&(O.style.display=l?"block":"none");const N=document.getElementById("preferencesSection");N&&(N.style.display="block");const C=document.getElementById("privacyDataSection");C&&(C.style.display=l?"block":"none");const R=document.getElementById("dangerZoneSection");R&&(R.style.display=l?"block":"none");const P=document.getElementById("authUserInfo");if(P){P.style.display=l?"block":"none";const K=document.getElementById("authUserEmail");if(K){const M=Q(u);K.textContent=M||"(이메일 없음)"}const $=document.getElementById("authUserName");$&&($.textContent=l||"Guest")}const x=document.getElementById("cloudSaveSection");x&&(x.style.display=l?"block":"none");const F=document.getElementById("guestSaveInfo");F&&(F.style.display=l?"none":"block")}const d=await U();h(d);const y=q(u=>h(u));async function m(u){if(!k()){c("현재는 게스트 모드입니다. 로그인 기능은 준비 중입니다.");return}c(t==="hub"?"Redirecting…":"이동 중…"),(await j(u)).ok||c(t==="hub"?"Login failed":"로그인 실패")}async function E(){if(!k())return;(await J()).ok?c(t==="hub"?"Signed out":"로그아웃"):c(t==="hub"?"Logout failed":"로그아웃 실패")}a&&a.addEventListener("click",u=>{u.preventDefault(),m(r)}),o.forEach(u=>{var b;const l=(b=u==null?void 0:u.dataset)==null?void 0:b.authProvider;l&&u.addEventListener("click",v=>{v.preventDefault(),m(l)})}),i&&i.addEventListener("click",u=>{u.preventDefault(),E()});const T=document.getElementById("deleteDataBtn");T&&T.addEventListener("click",async u=>{u.preventDefault(),await te(t,c,E)});const B=document.getElementById("deleteAccountBtn");return B&&B.addEventListener("click",async u=>{u.preventDefault(),await ne(t,c,E)}),{off:y}}async function te(e,t,o){var s,f,c,h;const r=typeof t=="function"?t:()=>{};if(!confirm(`모든 클라우드 데이터(저장, 리더보드)와 로컬 게임 저장을 삭제하시겠습니까?

⚠️ 이 작업은 되돌릴 수 없으며, 삭제 후에는 로그아웃됩니다.

언어 설정은 유지됩니다.`)||!confirm(`정말로 삭제하시겠습니까?

삭제될 데이터:
• 클라우드 저장
• 리더보드 기록
• 로컬 게임 저장

삭제 후에는 로그아웃되고 페이지가 새로고침됩니다.`))return;r(e==="hub"?"Deleting data…":"데이터 삭제 중…");let n;try{n=await Z()}catch(d){console.error("Delete user data exception:",d),r("데이터 삭제 중 오류가 발생했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.");return}if(!n.ok){let d;if(n.reason==="not_configured")d="데이터 삭제 기능이 설정되지 않았습니다.";else if(n.reason==="not_signed_in")d="로그인 상태가 아닙니다. 다시 로그인해주세요.";else if(n.reason==="delete_saves_failed"||n.reason==="delete_leaderboard_failed"){const y=((s=n.error)==null?void 0:s.code)||((f=n.error)==null?void 0:f.status)||"";y===401||y===403?d="권한이 없습니다. 다시 로그인해주세요.":d=e==="hub"?`데이터 삭제 실패: ${n.reason}. 네트워크 연결을 확인하고 다시 시도해주세요.`:`데이터 삭제 실패: ${n.reason}. 네트워크 연결을 확인하고 다시 시도해주세요.`}else d=e==="hub"?`데이터 삭제 실패: ${n.reason||"알 수 없는 오류"}. 다시 시도해주세요.`:`데이터 삭제 실패: ${n.reason||"알 수 없는 오류"}. 다시 시도해주세요.`;r(d),console.error("Delete user data failed:",n),(n.reason==="not_signed_in"||((c=n.error)==null?void 0:c.code)===401||((h=n.error)==null?void 0:h.code)===403)&&setTimeout(()=>{confirm("로그아웃하시겠습니까?")&&o()},1e3);return}try{const d=["clicksurvivor-auth","seoulTycoonSaveV1"];Object.keys(localStorage).forEach(m=>{m.startsWith("clicksurvivor-")&&m!=="clicksurvivor_lang"&&d.push(m)}),d.forEach(m=>{try{localStorage.removeItem(m)}catch(E){console.warn(`Failed to remove localStorage key "${m}":`,E)}})}catch(d){console.warn("Failed to clear localStorage:",d)}r(e==="hub"?"Data deleted. Signing out…":"데이터가 삭제되었습니다. 로그아웃 중…"),await o(),setTimeout(()=>{window.location.reload()},500)}async function ne(e,t,o){const r=typeof t=="function"?t:()=>{};if(!confirm(`계정과 모든 데이터를 영구적으로 삭제하시겠습니까?

⚠️ 삭제될 내용:
• 계정 정보 (이메일, 로그인 정보)
• 클라우드 저장
• 리더보드 기록
• 로컬 게임 저장

이 작업은 되돌릴 수 없으며, 삭제 후에는 로그아웃됩니다.

언어 설정은 유지됩니다.`)||!confirm(`정말로 계정을 삭제하시겠습니까?

이 작업은 다음을 포함합니다:
• 계정 정보 완전 삭제
• 모든 클라우드 데이터 삭제
• 모든 로컬 게임 저장 삭제

삭제 후에는 로그아웃되고 페이지가 새로고침됩니다.

이 작업은 되돌릴 수 없습니다.`))return;r(e==="hub"?"Deleting account…":"계정 삭제 중…");let n;try{n=await z()}catch(s){console.error("Delete account exception:",s),r("계정 삭제 중 오류가 발생했습니다. 네트워크 연결을 확인하고 다시 시도해주세요.");return}if(!n.ok){let s;n.status==="NOT_CONFIGURED"?s="계정 삭제 기능이 설정되지 않았습니다. 고객지원에 문의해주세요.":n.status==="AUTH_FAILED"?s="로그인 상태가 만료되었습니다. 다시 로그인해주세요.":n.status==="DATA_DELETED_BUT_AUTH_DELETE_FAILED"?s="데이터는 삭제되었지만 계정 삭제에 실패했습니다. 고객지원에 문의해주세요.":n.reason==="timeout"?s="요청 시간이 초과되었습니다. 네트워크 연결을 확인하고 다시 시도해주세요.":n.reason==="network_error"?s="네트워크 오류가 발생했습니다. 연결을 확인하고 다시 시도해주세요.":n.httpStatus===404?s="계정 삭제 기능이 아직 준비되지 않았습니다. 고객지원에 문의해주세요.":s=e==="hub"?`계정 삭제 실패: ${n.reason||"알 수 없는 오류"}. 다시 시도해주세요.`:`계정 삭제 실패: ${n.reason||"알 수 없는 오류"}. 다시 시도해주세요.`,r(s),console.error("Delete account failed:",n);return}try{const s=["clicksurvivor-auth","seoulTycoonSaveV1"];Object.keys(localStorage).forEach(c=>{c.startsWith("clicksurvivor-")&&c!=="clicksurvivor_lang"&&s.push(c)}),s.forEach(c=>{try{localStorage.removeItem(c)}catch(h){console.warn(`Failed to remove localStorage key "${c}":`,h)}})}catch(s){console.warn("Failed to clear localStorage:",s)}r(e==="hub"?"Account deleted. Signing out…":"계정이 삭제되었습니다. 로그아웃 중…");try{await o()}catch(s){console.warn("Logout after account deletion failed (expected):",s)}setTimeout(()=>{window.location.reload()},1e3)}function g(e){return document.querySelector(e)}function L(e){const t=g("#toast");t&&(t.textContent=e,t.classList.add("show"),window.clearTimeout(L._t),L._t=window.setTimeout(()=>t.classList.remove("show"),1400))}function oe(){return location.pathname.includes("/seoulsurvival/")?"game":"hub"}window.addEventListener("DOMContentLoaded",async()=>{const e=g("#loginBtn")||g("#authLoginBtn"),t=g("#logoutBtn")||g("#authLogoutBtn"),o=g("#authUserLabel"),r=g("#authStatusLabel"),a=Array.from(document.querySelectorAll("[data-auth-provider]")),i=g("#drawerAuthLoginBtn"),n=g("#drawerAuthLogoutBtn"),s=g("#drawerAuthUserLabel");!e&&!i&&a.length===0||await ee({scope:oe(),providerButtons:a,defaultProvider:"google",loginBtn:e||i,logoutBtn:t||n,userLabel:o||s,statusLabel:r,toast:L})});export{U as a,W as b,w as g,k as i,q as o,j as s};
