# 계정 삭제 리스크 설계

## 리스크 분석 표

| 리스크 | 현상 | 원인 | 대응 | 사용자 안내 | 테스트 방법 |
|--------|------|------|------|-------------|-------------|
| **Service Role Key 노출** | 프론트엔드 번들에 서비스 키가 포함됨 | 실수로 클라이언트 코드에 키 하드코딩 | Edge Function에서만 사용, 프론트엔드는 절대 접근 불가 | N/A (사용자에게 노출되지 않음) | 번들 분석 도구로 키 검색, CI에서 검증 |
| **JWT 만료/검증 실패 (401)** | Edge Function 호출 시 401 에러 | 토큰 만료, 잘못된 토큰, 토큰 없음 | Edge Function에서 JWT 검증 실패 시 AUTH_FAILED 반환 | "로그인 상태가 만료되었습니다. 다시 로그인해주세요." | 토큰 만료 시뮬레이션, 잘못된 토큰 전송 |
| **권한 문제 (403) / RLS** | Edge Function 호출 시 403 에러 | RLS 정책 위반, 권한 부족 | Edge Function은 서비스 역할로 실행되므로 RLS 우회 | "권한이 없습니다. 다시 로그인해주세요." | 권한 없는 사용자로 시도 |
| **부분 성공 (데이터 삭제 OK, 계정 삭제 FAIL)** | game_saves/leaderboard는 삭제되었지만 auth.users는 남음 | admin.deleteUser() 실패, 네트워크 중단 | Edge Function에서 트랜잭션 처리, 부분 성공 시 DATA_DELETED_BUT_AUTH_DELETE_FAILED 반환 | "데이터는 삭제되었지만 계정 삭제에 실패했습니다. 고객지원에 문의해주세요." | Edge Function에서 deleteUser 실패 시뮬레이션 |
| **네트워크 실패/타임아웃** | Edge Function 호출 실패, 응답 없음 | 네트워크 오류, 타임아웃, Edge Function 다운 | 프론트엔드에서 타임아웃 설정(30초), 재시도 버튼 제공 | "네트워크 오류가 발생했습니다. 연결을 확인하고 다시 시도해주세요." | 네트워크 오프라인 모드, 타임아웃 시뮬레이션 |
| **Edge Function 미배포/미설정 (404)** | Edge Function을 찾을 수 없음 | 함수 미배포, 경로 오류 | 프론트엔드에서 404 감지, 명확한 에러 메시지 | "계정 삭제 기능이 아직 준비되지 않았습니다. 고객지원에 문의해주세요." | 존재하지 않는 함수 호출 |
| **멀티 탭에서 동시 삭제 시도** | 여러 탭에서 동시에 삭제 요청 | 사용자가 여러 탭에서 동시 클릭 | 첫 번째 요청만 처리, 나머지는 "이미 처리 중" 메시지 | "계정 삭제가 이미 진행 중입니다. 잠시만 기다려주세요." | 여러 탭에서 동시 클릭 |
| **삭제 후 UI 상태** | 삭제 후 로그아웃/리로드가 제대로 안 됨 | 상태 관리 오류, 비동기 처리 문제 | 삭제 성공 시 즉시 로그아웃 → LocalStorage 정리 → 리로드 | "계정이 삭제되었습니다. 페이지를 새로고침합니다." | 삭제 성공 후 UI 상태 확인 |
| **데이터 정합성** | leaderboard/game_saves가 남는 경우 | 삭제 실패, 트랜잭션 롤백 실패 | Edge Function에서 트랜잭션 처리, 실패 시 롤백 | "일부 데이터 삭제에 실패했습니다. 고객지원에 문의해주세요." | 삭제 실패 시뮬레이션 후 DB 확인 |
| **사용자 혼동 (데이터 삭제 vs 계정 삭제)** | "내 데이터 삭제"와 "계정 삭제"를 혼동 | UI/문구가 불명확 | 명확한 구분: "내 데이터 삭제"는 데이터만, "계정 삭제"는 계정+데이터 모두 | "계정 삭제는 모든 데이터와 계정 정보를 영구적으로 삭제합니다." | 사용자 테스트, 문구 검토 |

## 보안 체크리스트

- [x] Service Role Key는 Edge Function 환경 변수에만 저장
- [x] 프론트엔드 코드에 Service Role Key 포함 금지
- [x] Edge Function에서만 admin.deleteUser() 호출
- [x] JWT 검증은 Edge Function에서 수행
- [x] 민감 정보는 로그에 남기지 않음
- [x] 2단계 confirm으로 실수 방지
- [x] 삭제 후 즉시 로그아웃 및 LocalStorage 정리















