# localhost 로그인 리다이렉트 문제 해결

## 문제
로컬 환경(`http://localhost:4173`)에서 Login 버튼을 클릭하면, 로컬 환경에서 로그인되는 것이 아니라 `clicksurvivor.com`(프로덕션)으로 넘어가는 문제.

## 원인 분석

### 코드 확인
`shared/auth/core.js`의 `signInGoogle()` 함수는 `location.origin`을 사용하여 동적으로 콜백 URL을 생성합니다:

```javascript
export async function signInGoogle(nextUrl = null) {
  const callbackUrl = `${location.origin}/auth/callback`;
  // ...
}
```

이것은 정상적으로 보이지만, Supabase 설정에서 문제가 발생할 수 있습니다.

### 가능한 원인

1. **Supabase Site URL 설정**
   - Supabase 대시보드의 Site URL이 `https://clicksurvivor.com`으로 고정되어 있으면, Supabase가 `redirectTo`를 무시하고 Site URL을 사용할 수 있습니다.

2. **Supabase Redirect URLs 화이트리스트**
   - `http://localhost:4173/auth/callback`이 Supabase Redirect URLs에 등록되어 있지 않으면, Supabase가 기본 Site URL로 리다이렉트합니다.

3. **Google OAuth 설정**
   - Google Cloud Console의 Authorized JavaScript origins에 `http://localhost:4173`이 등록되어 있지 않으면, OAuth 플로우가 실패할 수 있습니다.

## 해결 방법

### 1. Supabase 대시보드 설정 확인

#### Site URL 설정
- Supabase 대시보드 → **Authentication** → **URL Configuration** → **Site URL**
- **개발 환경**: `http://localhost:4173` (또는 사용 중인 포트)
- **프로덕션**: `https://clicksurvivor.com`

**주의**: Site URL은 하나만 설정할 수 있으므로, 개발 환경에서는 로컬 URL을 사용하고, 프로덕션 배포 시 프로덕션 URL로 변경해야 합니다.

#### Redirect URLs 화이트리스트
- Supabase 대시보드 → **Authentication** → **URL Configuration** → **Redirect URLs**
- 다음 URL들을 모두 추가:
  - `http://localhost:5173/auth/callback` (Vite dev 서버)
  - `http://localhost:4173/auth/callback` (Vite preview 서버)
  - `https://clicksurvivor.com/auth/callback` (프로덕션)

### 2. Google OAuth 설정 확인

#### Authorized JavaScript origins
- Google Cloud Console → **APIs & Services** → **Credentials** → **OAuth 2.0 Client ID**
- 다음 origins를 추가:
  - `http://localhost:5173`
  - `http://localhost:4173`
  - `https://clicksurvivor.com`

#### Authorized redirect URIs
- Supabase 콜백 URL을 추가:
  - `https://<YOUR_SUPABASE_PROJECT_ID>.supabase.co/auth/v1/callback`
  - (프로덕션과 개발 환경 모두 동일한 Supabase 콜백 URL 사용)

### 3. 디버깅 로그 추가

`shared/auth/core.js`에 디버깅 로그를 추가하여 실제 `redirectTo` 값을 확인:

```javascript
export async function signInGoogle(nextUrl = null) {
  const callbackUrl = `${location.origin}/auth/callback`;
  
  console.log('[signInGoogle] Current origin:', location.origin);
  console.log('[signInGoogle] Callback URL:', callbackUrl);
  
  // ...
  
  console.log('[signInGoogle] Final redirectTo:', redirectTo);
  
  return signInWithOAuth('google', redirectTo);
}
```

브라우저 콘솔에서 이 로그를 확인하여 실제 `redirectTo` 값이 올바른지 확인합니다.

## 검증 방법

1. **로컬 환경에서 Login 버튼 클릭**
2. **브라우저 콘솔 확인**:
   - `[signInGoogle] Current origin: http://localhost:4173`
   - `[signInGoogle] Callback URL: http://localhost:4173/auth/callback`
   - `[signInGoogle] Final redirectTo: http://localhost:4173/auth/callback`
3. **Google OAuth 페이지 확인**: URL이 `http://localhost:4173`을 포함하는지 확인
4. **로그인 후 리다이렉트 확인**: `/auth/callback`이 `http://localhost:4173/auth/callback`인지 확인

## 주의사항

- **Site URL은 하나만 설정 가능**: 개발 환경에서는 로컬 URL을 사용하고, 프로덕션 배포 시 프로덕션 URL로 변경해야 합니다.
- **Redirect URLs는 여러 개 등록 가능**: 로컬/프로덕션 URL을 모두 등록하면 두 환경 모두에서 작동합니다.
- **Google OAuth 설정**: Authorized JavaScript origins와 Authorized redirect URIs를 모두 올바르게 설정해야 합니다.





