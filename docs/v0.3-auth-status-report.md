# v0.3 Auth 현황 리포트 (Commit 1)

## 1. 현재 인증 구조 개요

### 1.1 파일 구조
```
shared/auth/
├── core.js          # 핵심 인증 함수 (signInWithOAuth, signOut, getUser, onAuthStateChange)
├── ui.js            # UI 초기화 및 이벤트 핸들러 (initAuthUI)
├── config.js        # Supabase 설정 (동적 import)
├── supabaseClient.js # Supabase 클라이언트 생성
├── deleteAccount.js  # 계정 삭제 (Edge Function 호출)
└── deleteUserData.js # 사용자 데이터 삭제
```

### 1.2 주요 함수 위치

#### signInWithOAuth 호출 위치
- **`shared/auth/core.js:47`**: `signInWithOAuth(provider)` 함수 정의
- **`shared/auth/ui.js:154`**: `doLogin(provider)` 함수에서 호출
- **`seoulsurvival/src/main.js:8363, 8500`**: 직접 호출 (2곳)

#### redirectTo 값
- **현재 구현**: `location.origin + location.pathname + location.search` (동적 생성)
- **문제점**: 각 페이지마다 다른 redirectTo 사용 → Supabase 화이트리스트 관리 복잡
- **권장**: 공통 콜백 엔드포인트 필요 (`/auth/callback`)

#### 콜백 처리
- **현재 구현**: `shared/auth/core.js:17`의 `initAuthFromUrl()` 함수
  - `?code=` 파라미터 감지
  - `exchangeCodeForSession(location.href)` 호출
  - URL에서 `code`, `state` 파라미터 제거
- **문제점**: 별도의 `/auth/callback` 페이지 없음 → 모든 페이지에서 콜백 처리 필요

### 1.3 세션 상태 관리

#### 현재 구현
- **`getUser()`**: `supabase.auth.getUser()` 사용
- **`onAuthStateChange()`**: `supabase.auth.onAuthStateChange()` 구독
- **`initAuthFromUrl()`**: OAuth 리다이렉트 후 세션 교환

#### 사용 위치
- **허브**: `hub/main.js`에서 `initHeaderAuth()` 호출
- **게임**: `shared/authBoot.js`에서 `initAuthUI()` 호출
- **계정 페이지**: `account/main.js`에서 `initHeaderAuth()` 호출

### 1.4 닉네임 시스템

#### 테이블 구조
- **테이블**: `nickname_registry` (Supabase)
- **컬럼**: `game_slug`, `nickname_key` (NFC 정규화), `nickname_raw` (표시용), `user_id`
- **제약**: `UNIQUE (game_slug, nickname_key)`, `UNIQUE (game_slug, user_id)`

#### 함수 위치
- **`shared/leaderboard.js`**:
  - `normalizeNickname(raw)`: NFC 정규화 + key 생성
  - `validateNickname(raw)`: 유효성 검사 (1~6자, 허용 문자, 금칙어)
  - `claimNickname(raw, userId)`: 닉네임 클레임 (RPC 함수 호출)
  - `releaseNickname(userId, gameSlug)`: 닉네임 회수

#### RPC 함수
- **`claim_nickname`**: 닉네임 클레임 (원자적 연산)
- **`release_nickname`**: 닉네임 회수

### 1.5 계정 삭제

#### 현재 구현
- **`shared/auth/deleteAccount.js`**: Edge Function 호출
- **엔드포인트**: `${SUPABASE_URL}/functions/v1/delete-account`
- **방식**: JWT 토큰을 첨부하여 POST 요청
- **서버 측**: Edge Function에서 `service_role`로 `auth.admin.deleteUser()` 호출

#### 문제점
- Edge Function이 실제로 존재하는지 확인 필요
- 클라이언트에서 직접 `deleteUser` 호출하지 않음 (올바름)

## 2. 개선 계획

### 2.1 OAuth/세션/리다이렉트 안정화

#### A. signInWithOAuth 표준화
- **현재**: 각 페이지마다 다른 `redirectTo` 사용
- **개선**: 공통 콜백 엔드포인트 `/auth/callback` 사용
- **구현**:
  ```javascript
  const redirectTo = `${location.origin}/auth/callback`;
  ```

#### B. 세션 상태 동기화
- **현재**: `initAuthFromUrl()`이 모든 페이지에서 호출됨
- **개선**: `/auth/callback` 페이지에서만 세션 교환, 이후 원래 목적지로 리다이렉트
- **구현**:
  - `/auth/callback` 페이지 생성
  - `nextUrl` 파라미터로 원래 목적지 저장
  - 세션 교환 후 `nextUrl`로 리다이렉트

#### C. 콜백 처리
- **현재**: 모든 페이지에서 `initAuthFromUrl()` 호출
- **개선**: `/auth/callback` 페이지에서만 처리
- **구현**:
  - `auth/callback.html` 생성
  - `auth/callback/main.js` 생성
  - 세션 교환 후 원래 목적지로 리다이렉트

### 2.2 커스텀 Google 로그인 버튼

#### 현재 상태
- GIS 렌더 버튼 사용 안 함
- 커스텀 HTML 버튼 사용
- 브랜딩 가이드 준수 여부 확인 필요

#### 개선 사항
- Google Sign-In 브랜딩 가이드 준수 확인
- 버튼 스타일을 SeoulSurvival 유니폼에 맞추되, Google 로고/색 규정 준수
- 주변 UI(헤더 틴트/링크/배지)만 팀컬러 적용

### 2.3 공통 Auth 모듈화

#### 현재 상태
- `shared/auth/core.js`: 핵심 함수 존재
- `shared/auth/ui.js`: UI 초기화 함수 존재
- 중복 코드 없음 (이미 모듈화됨)

#### 개선 사항
- `signInGoogle(nextUrl)` 함수 추가 (redirectTo 통일)
- `getUserProfile()` 함수 추가 (닉네임/유저ID 조회)
- 모든 페이지에서 공통 모듈 사용 확인

### 2.4 /account 페이지 완성

#### 현재 상태
- `account/index.html`: UI 구조 존재
- `account/main.js`: 닉네임 변경/로그아웃/계정 삭제 기능 연결됨
- Toast 메시지 시스템 구현됨

#### 개선 사항
- 현재 닉네임 표시 (닉네임 조회 API 필요)
- 닉네임 변경 쿨타임 표시 (30초)
- 더 나은 에러 메시지 처리

### 2.5 계정 삭제 서버 측 구현

#### 현재 상태
- `shared/auth/deleteAccount.js`: Edge Function 호출
- Edge Function 존재 여부 확인 필요

#### 개선 사항
- Edge Function 코드 확인/생성
- 서버 측 `auth.admin.deleteUser()` 구현 확인
- 클라이언트 연동 테스트

## 3. 리스크 및 주의사항

### 3.1 리스크
1. **Supabase Redirect URLs 화이트리스트**: `/auth/callback` 추가 필요
2. **Google OAuth 설정**: Authorized JavaScript origins 확인 필요
3. **Edge Function 배포**: 계정 삭제 기능이 실제로 작동하는지 확인 필요
4. **세션 동기화**: 모든 페이지에서 로그인 상태가 즉시 반영되는지 확인 필요

### 3.2 주의사항
- 기존 SeoulSurvival UI 규격 절대 변경 금지
- 인증/저장/리더보드 기존 구현 재사용
- service_role 키 클라이언트 노출 절대 금지
- 아바타 기능 구현 금지

## 4. 다음 단계 (Commit 2~6)

### Commit 2: shared/auth 모듈 생성 + 공통 사용
- `signInGoogle(nextUrl)` 함수 추가
- `getUserProfile()` 함수 추가
- 모든 페이지에서 공통 모듈 사용 확인

### Commit 3: /auth/callback 구현
- `auth/callback.html` 생성
- `auth/callback/main.js` 생성
- Redirect URL 화이트리스트 정리 (문서화)

### Commit 4: /account 페이지 구현
- 현재 닉네임 표시
- 닉네임 변경 쿨타임 표시
- 에러 메시지 개선

### Commit 5: 계정 삭제 서버 측 엔드포인트
- Edge Function 코드 확인/생성
- 클라이언트 연동 테스트

### Commit 6: DEVLOG 업데이트 + 스모크 테스트
- DEVLOG.md 업데이트
- 스모크 테스트 체크리스트 문서화





